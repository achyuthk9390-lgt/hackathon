<!DOCTYPE html>
<html>
<head>
    <title>Fraud Detection Dashboard</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Vis Network -->
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: white;
        }

        .dashboard {
            padding: 40px;
            max-width: 1200px;
            margin: auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 40px;
        }

        .grid {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            flex: 1;
            padding: 25px;
            border-radius: 20px;
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(15px);
            text-align: center;
        }

        .card.red { background: rgba(255,0,0,0.15); }
        .card.yellow { background: rgba(255,204,0,0.15); }

        .counter {
            font-size: 30px;
            margin-top: 10px;
        }

        .large-card {
            padding: 40px;
            margin-bottom: 30px;
            border-radius: 20px;
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(15px);
        }

        #network {
            height: 500px;
            margin-top: 20px;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .red-dot { background: #ff3b3b; }
        .yellow-dot { background: #ffcc00; }
        .green-dot { background: #00cc66; }
    </style>
</head>

<body>

<div class="dashboard">

    <h1>üìä Financial Crime Intelligence Dashboard</h1>

    <!-- SUMMARY -->
    <div class="grid">
        <div class="card">
            <h3>Total Accounts</h3>
            <div class="counter" data-target="{{ graph_data.nodes|length }}">0</div>
        </div>

        <div class="card red">
            <h3>Fraud Rings</h3>
            <div class="counter" data-target="{{ fraud_rings|length }}">0</div>
        </div>

        <div class="card yellow">
            <h3>Suspicious Accounts</h3>
            <div class="counter" data-target="{{ suspicious_accounts|length }}">0</div>
        </div>
    </div>

    <!-- PIE CHART -->
    <div class="large-card">
        <h2>üìà Risk Distribution</h2>
        <canvas id="riskChart"></canvas>
    </div>

    <!-- GRAPH -->
    <div class="large-card">
        <h2>üåê Transaction Network</h2>

        <div class="legend">
            <div><span class="dot red-dot"></span>Fraud</div>
            <div><span class="dot yellow-dot"></span>Medium</div>
            <div><span class="dot green-dot"></span>Safe</div>
        </div>

        <div id="network"></div>
    </div>

</div>

<script>
/* ========== SAFE GRAPH DATA ========== */

const graphData = {{ graph_data | tojson | safe }};

/* If risk_map doesn't exist, use empty object */
const riskMap = graphData.risk_map || {};

let nodes = new vis.DataSet();
let edges = new vis.DataSet();

let fraudCount = 0;
let mediumCount = 0;
let safeCount = 0;

(graphData.nodes || []).forEach(node => {

    let risk = riskMap[node] || 0;
    let color = "#00cc66";

    if (risk >= 80) {
        color = "#ff3b3b";
        fraudCount++;
    } else if (risk >= 40) {
        color = "#ffcc00";
        mediumCount++;
    } else {
        safeCount++;
    }

    nodes.add({
        id: node,
        label: node,
        color: color
    });
});

(graphData.edges || []).forEach(edge => {
    edges.add({
        from: edge[0],
        to: edge[1]
    });
});

new vis.Network(
    document.getElementById("network"),
    { nodes: nodes, edges: edges },
    {
        nodes: { shape: "dot", size: 16 },
        edges: { arrows: "to" }
    }
);

/* ========== PIE CHART ========== */

new Chart(document.getElementById("riskChart"), {
    type: 'pie',
    data: {
        labels: ['Fraud', 'Medium', 'Safe'],
        datasets: [{
            data: [fraudCount, mediumCount, safeCount],
            backgroundColor: ['#ff3b3b','#ffcc00','#00cc66']
        }]
    }
});

/* ========== ANIMATED COUNTERS ========== */

document.querySelectorAll('.counter').forEach(counter => {
    const target = +counter.getAttribute('data-target');
    let count = 0;

    const update = () => {
        if (count < target) {
            count += Math.ceil(target / 50);
            counter.innerText = count;
            setTimeout(update, 20);
        } else {
            counter.innerText = target;
        }
    };

    update();
});
</script>

</body>
</html>
