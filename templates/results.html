<!DOCTYPE html>
<html>
<head>
    <title>Fraud Detection Dashboard</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Vis Network -->
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <link rel="stylesheet" href="/static/css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dark-theme">

<div class="dashboard">

    <h1 class="title">üìä Financial Crime Intelligence Dashboard</h1>

    <!-- ================= SUMMARY CARDS ================= -->

    <div class="card-grid">

        <div class="glass-card">
            <h3>Total Accounts</h3>
            <h2 class="counter" data-target="{{ graph_data.nodes|length }}">0</h2>
        </div>

        <div class="glass-card red-glass">
            <h3>Fraud Rings</h3>
            <h2 class="counter" data-target="{{ fraud_rings|length }}">0</h2>
        </div>

        <div class="glass-card yellow-glass">
            <h3>Suspicious Accounts</h3>
            <h2 class="counter" data-target="{{ suspicious_accounts|length }}">0</h2>
        </div>

    </div>

    <!-- ================= PIE CHART ================= -->

    <div class="glass-card large-card">
        <h2>üìà Risk Distribution</h2>
        <canvas id="riskChart"></canvas>
    </div>

    <!-- ================= GRAPH ================= -->

    <div class="glass-card large-card">
        <h2>üåê Transaction Network</h2>

        <!-- LEGEND -->
        <div class="legend">
            <span class="legend-item"><span class="dot red"></span> Fraud</span>
            <span class="legend-item"><span class="dot yellow"></span> Medium</span>
            <span class="legend-item"><span class="dot green"></span> Safe</span>
        </div>

        <div id="network"></div>
    </div>

</div>

<script>
/* ================= ANIMATED COUNTERS ================= */

const counters = document.querySelectorAll('.counter');

counters.forEach(counter => {
    const update = () => {
        const target = +counter.getAttribute('data-target');
        const current = +counter.innerText;

        const increment = target / 50;

        if (current < target) {
            counter.innerText = Math.ceil(current + increment);
            setTimeout(update, 20);
        } else {
            counter.innerText = target;
        }
    };

    update();
});


/* ================= GRAPH ================= */

const graphData = {{ graph_data | tojson }};
let nodes = new vis.DataSet();
let edges = new vis.DataSet();

let fraudCount = 0;
let mediumCount = 0;
let safeCount = 0;

graphData.nodes.forEach(node => {

    let risk = graphData.risk_map[node] || 0;
    let color = "#00cc66";

    if (risk >= 80) {
        color = "#ff3b3b";
        fraudCount++;
    } else if (risk >= 40) {
        color = "#ffcc00";
        mediumCount++;
    } else {
        safeCount++;
    }

    nodes.add({
        id: node,
        label: node,
        color: {
            background: color,
            border: "#ffffff"
        }
    });
});

graphData.edges.forEach(edge => {
    edges.add({
        from: edge[0],
        to: edge[1]
    });
});

new vis.Network(
    document.getElementById("network"),
    { nodes: nodes, edges: edges },
    {
        nodes: {
            shape: "dot",
            size: 18,
            font: { color: "white" }
        },
        edges: {
            arrows: "to",
            color: { color: "#aaa" }
        },
        physics: { stabilization: false }
    }
);


/* ================= PIE CHART ================= */

const ctx = document.getElementById('riskChart');

new Chart(ctx, {
    type: 'pie',
    data: {
        labels: ['Fraud', 'Medium', 'Safe'],
        datasets: [{
            data: [fraudCount, mediumCount, safeCount],
            backgroundColor: [
                '#ff3b3b',
                '#ffcc00',
                '#00cc66'
            ]
        }]
    },
    options: {
        plugins: {
            legend: {
                labels: { color: 'white' }
            }
        }
    }
});
</script>

</body>
</html>
